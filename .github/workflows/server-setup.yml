name: Server Initial Setup

on:
  workflow_dispatch:
    inputs:
      task:
        description: 'Setup task to run'
        required: true
        type: choice
        options:
          - clone-and-setup
          - fix-build-and-env
          - fix-public-html
          - fix-webserver
          - diagnose-web
          - check-status
          - remove-workflow

jobs:
  setup:
    name: Server Setup
    runs-on: ubuntu-latest

    steps:
      - name: Run setup via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          command_timeout: 10m
          script: |
            TASK="${{ inputs.task }}"
            DEPLOY_PATH="${{ secrets.DEPLOY_PATH }}"
            DEPLOY_PATH="${DEPLOY_PATH:-/home/admin/domains/tpix.online}"

            echo "Task: $TASK"
            echo "Path: $DEPLOY_PATH"
            echo "User: $(whoami)"

            case "$TASK" in
              clone-and-setup)
                echo "=== Step 1: Prepare directory ==="
                if [ -d "$DEPLOY_PATH/.git" ]; then
                  echo "Git repo already exists, pulling latest..."
                  cd "$DEPLOY_PATH"
                  git fetch origin main
                  git reset --hard origin/main
                else
                  echo "Cloning fresh repo..."
                  echo "Checking what exists..."
                  ls -la "$(dirname $DEPLOY_PATH)/" 2>/dev/null || echo "Parent dir not found"
                  ls -la "$DEPLOY_PATH/" 2>/dev/null || echo "Deploy path not found"

                  # Direct clone into deploy path
                  mkdir -p "$DEPLOY_PATH"
                  git clone https://github.com/xjanova/ThaiXTrade.git "$DEPLOY_PATH/repo_tmp"
                  # Move git content into deploy path
                  mv "$DEPLOY_PATH/repo_tmp/"* "$DEPLOY_PATH/repo_tmp/".[!.]* "$DEPLOY_PATH/" 2>/dev/null || true
                  rm -rf "$DEPLOY_PATH/repo_tmp"

                  cd "$DEPLOY_PATH"
                  echo "Cloned successfully. Files:"
                  ls -la | head -15
                fi

                echo "=== Step 2: Install Composer ==="
                composer install --no-dev --optimize-autoloader --no-interaction 2>&1 || {
                  echo "Trying with --no-scripts..."
                  composer install --no-dev --optimize-autoloader --no-interaction --no-scripts
                  composer dump-autoload --optimize
                }

                echo "=== Step 3: Setup .env ==="
                if [ ! -f ".env" ]; then
                  cp .env.example .env
                  php artisan key:generate --force
                  echo "Created new .env with fresh APP_KEY"
                else
                  echo ".env already exists, keeping it"
                fi

                echo "=== Step 4: NPM Install & Build ==="
                npm ci --prefer-offline 2>&1 || npm install 2>&1
                npm run build

                echo "=== Step 5: Database ==="
                php artisan migrate --force 2>&1 || echo "Migration warnings (non-fatal)"

                echo "=== Step 6: Permissions ==="
                chmod -R 775 storage bootstrap/cache 2>/dev/null || true
                chmod +x deploy.sh 2>/dev/null || true

                echo "=== Step 7: Optimize ==="
                php artisan config:clear
                php artisan route:clear
                php artisan view:clear
                php artisan config:cache
                php artisan route:cache
                php artisan view:cache

                echo "=== Step 8: Storage link ==="
                if [ ! -L "public_html/storage" ]; then
                  php artisan storage:link 2>/dev/null || true
                fi

                echo "=== Verify ==="
                php artisan --version
                ls -la public_html/build/ 2>/dev/null | head -5 || echo "No build dir yet"

                echo ""
                echo "=============================="
                echo "SETUP COMPLETE"
                echo "=============================="
                ;;

              fix-build-and-env)
                cd "$DEPLOY_PATH" || { echo "Path not found: $DEPLOY_PATH"; exit 1; }

                echo "=== Step 1: Configure .env for production ==="
                # Update .env for production
                sed -i 's/^APP_ENV=.*/APP_ENV=production/' .env
                sed -i 's/^APP_DEBUG=.*/APP_DEBUG=false/' .env
                sed -i 's|^APP_URL=.*|APP_URL=https://tpix.online|' .env

                echo "Current .env settings:"
                grep -E "^APP_ENV|^APP_DEBUG|^APP_URL|^DB_|^APP_KEY" .env

                echo ""
                echo "=== Step 2: Check Node.js ==="
                node --version
                npm --version
                echo "node_modules/.bin contents:"
                ls node_modules/.bin/vite 2>/dev/null && echo "vite binary found" || echo "vite binary NOT found"

                echo ""
                echo "=== Step 3: Reinstall NPM with devDependencies ==="
                npm install 2>&1
                echo "After install - vite check:"
                ls -la node_modules/.bin/vite 2>/dev/null || echo "Still no vite!"

                echo ""
                echo "=== Step 4: Build frontend assets ==="
                echo "Using direct node path to vite..."
                node ./node_modules/vite/bin/vite.js build 2>&1 || {
                  echo "Direct vite failed, trying with full path..."
                  NODE_PATH="$DEPLOY_PATH/node_modules" node "$DEPLOY_PATH/node_modules/vite/bin/vite.js" build 2>&1
                }

                echo ""
                echo "=== Step 5: Verify build output ==="
                ls -la public_html/build/ 2>/dev/null || echo "No build directory!"
                ls -la public_html/build/assets/ 2>/dev/null | head -10 || echo "No assets!"

                echo ""
                echo "=== Step 6: Re-cache Laravel ==="
                php artisan config:clear
                php artisan config:cache
                php artisan route:cache
                php artisan view:cache

                echo ""
                echo "=== Step 7: Fix permissions ==="
                chmod -R 775 storage bootstrap/cache 2>/dev/null || true
                chmod -R 775 public_html/build 2>/dev/null || true

                echo ""
                echo "=== Step 8: Test site ==="
                php artisan --version
                curl -s -o /dev/null -w "HTTP Status: %{http_code}" http://localhost 2>/dev/null || echo "Local curl not available"

                echo ""
                echo "=== Step 9: Check web server config ==="
                ls -la /home/admin/domains/tpix.online/ 2>/dev/null | head -10
                cat /home/admin/domains/tpix.online/nginx.conf 2>/dev/null | head -30 || echo "No nginx.conf in domain dir"
                ls /etc/nginx/sites-enabled/ 2>/dev/null || echo "No nginx sites-enabled"
                ls /etc/apache2/sites-enabled/ 2>/dev/null || echo "No apache sites-enabled"
                cat /usr/local/directadmin/data/users/admin/domains/tpix.online.conf 2>/dev/null | head -20 || echo "No DA domain config"

                echo ""
                echo "=== Step 10: Check DirectAdmin & public_html ==="
                echo "--- Domain root ---"
                ls -la "$DEPLOY_PATH/" 2>/dev/null | head -20
                echo "--- public_html contents ---"
                ls -la "$DEPLOY_PATH/public_html/" 2>/dev/null | head -20
                echo "--- index.php exists? ---"
                head -5 "$DEPLOY_PATH/public_html/index.php" 2>/dev/null || echo "NO index.php in public_html!"
                echo "--- .htaccess ---"
                cat "$DEPLOY_PATH/public_html/.htaccess" 2>/dev/null | head -25 || echo "No .htaccess"
                echo "--- Web server type ---"
                ls /usr/local/lsws/ 2>/dev/null && echo "OpenLiteSpeed detected" || echo "No OLS"
                nginx -v 2>&1 || echo "No nginx"
                apache2 -v 2>&1 || httpd -v 2>&1 || echo "No apache/httpd"
                echo "--- PHP handler ---"
                ls /usr/local/lsws/lsphp*/bin/lsphp 2>/dev/null || echo "No LSPHP"
                php -v 2>/dev/null | head -1

                echo ""
                echo "=============================="
                echo "BUILD & ENV FIX COMPLETE"
                echo "=============================="
                ;;

              fix-public-html)
                cd "$DEPLOY_PATH" || { echo "Path not found: $DEPLOY_PATH"; exit 1; }

                echo "=== Step 1: Check current public_html ==="
                echo "--- Before fix ---"
                ls -la public_html/ 2>/dev/null
                echo ""

                echo "=== Step 2: Restore public_html from git ==="
                git checkout HEAD -- public_html/ 2>&1
                echo ""

                echo "=== Step 3: Verify public_html ==="
                echo "--- After fix ---"
                ls -la public_html/ 2>/dev/null
                echo ""
                echo "--- index.php ---"
                head -10 public_html/index.php 2>/dev/null || echo "STILL NO index.php!"
                echo ""
                echo "--- .htaccess ---"
                cat public_html/.htaccess 2>/dev/null || echo "No .htaccess"
                echo ""

                echo "=== Step 4: Rebuild vite assets ==="
                node ./node_modules/vite/bin/vite.js build 2>&1
                echo ""

                echo "=== Step 5: Storage link ==="
                php artisan storage:link 2>/dev/null || echo "Storage link exists or failed"
                ls -la public_html/storage 2>/dev/null || echo "No storage link"
                echo ""

                echo "=== Step 6: Re-cache ==="
                php artisan config:clear
                php artisan config:cache
                php artisan route:cache
                php artisan view:cache
                echo ""

                echo "=== Step 7: Permissions ==="
                chmod -R 775 storage bootstrap/cache public_html/build 2>/dev/null || true
                echo ""

                echo "=== Step 8: Check web server ==="
                # Find the actual web server
                ps aux | grep -E "httpd|nginx|litespeed|lshttpd|apache" | grep -v grep | head -5
                echo "---"
                # Check if there's a custom httpd config
                find /etc/ -name "*.conf" -path "*tpix*" 2>/dev/null | head -5
                find /usr/local/ -name "*.conf" -path "*tpix*" 2>/dev/null | head -5
                # Check for openlitespeed or directadmin httpd
                ls /etc/openlitespeed/ 2>/dev/null && echo "OLS found at /etc/openlitespeed"
                ls /etc/httpd/ 2>/dev/null && echo "httpd found at /etc/httpd"
                which httpd 2>/dev/null || echo "httpd not in PATH"
                # DirectAdmin configs
                cat /usr/local/directadmin/data/users/admin/httpd.conf 2>/dev/null | head -30 || echo "No DA httpd.conf"
                echo ""

                echo "=== Step 9: Test HTTP ==="
                curl -s -o /dev/null -w "HTTP: %{http_code}\n" http://localhost 2>/dev/null
                curl -s -o /dev/null -w "HTTPS tpix.online: %{http_code}\n" https://tpix.online 2>/dev/null || echo "HTTPS not reachable from server"
                curl -s http://localhost 2>/dev/null | head -20
                echo ""

                echo "=============================="
                echo "PUBLIC_HTML FIX COMPLETE"
                echo "=============================="
                ;;

              fix-webserver)
                cd "$DEPLOY_PATH" || { echo "Path not found: $DEPLOY_PATH"; exit 1; }

                echo "=== Step 1: Remove DA default index.html ==="
                ls -la public_html/index.html 2>/dev/null && {
                  echo "Found DA default index.html - removing..."
                  rm -f public_html/index.html
                  echo "Removed."
                } || echo "No index.html found (good)"

                echo ""
                echo "=== Step 2: Check all files in public_html ==="
                find public_html/ -maxdepth 1 -type f -name "index*" 2>/dev/null
                ls -la public_html/ | head -20
                echo ""

                echo "=== Step 3: Check DA httpd config for tpix.online ==="
                grep -A 20 "tpix.online" /usr/local/directadmin/data/users/admin/httpd.conf 2>/dev/null | head -40
                echo "---"
                # Also check domain-specific configs
                cat /home/admin/domains/tpix.online/public_html/.htaccess 2>/dev/null | head -5 || echo "No .htaccess"
                echo ""

                echo "=== Step 4: Verify index.php works via PHP ==="
                cd public_html/
                php index.php 2>&1 | head -20
                cd ..
                echo ""

                echo "=== Step 5: Test with curl ==="
                curl -s -o /dev/null -w "HTTP %{http_code}" "http://tpix.online" 2>/dev/null || echo "curl to tpix.online failed"
                echo ""
                curl -s "https://tpix.online" 2>/dev/null | head -5
                echo ""

                echo "=== Step 6: Restart web server ==="
                sudo systemctl restart httpd 2>/dev/null || echo "Cannot restart httpd"
                sleep 2
                echo ""

                echo "=== Step 7: Test again after restart ==="
                curl -s "https://tpix.online" 2>/dev/null | head -10
                echo ""
                curl -s -o /dev/null -w "HTTP %{http_code}" "https://tpix.online" 2>/dev/null
                echo ""

                echo "=============================="
                echo "WEBSERVER FIX COMPLETE"
                echo "=============================="
                ;;

              diagnose-web)
                cd "$DEPLOY_PATH" || { echo "Path not found: $DEPLOY_PATH"; exit 1; }

                echo "=== DEPLOY_PATH ==="
                pwd
                echo "Real path: $(realpath .)"
                echo ""

                echo "=== Create test.php ==="
                echo '<?php echo "PHP_WORKS_OK"; phpinfo(INFO_GENERAL);' > public_html/test.php
                echo ""

                echo "=== Test direct file access ==="
                curl -s "https://tpix.online/test.php" 2>/dev/null | head -10
                echo ""
                echo "---"
                curl -s "https://tpix.online/index.php" 2>/dev/null | head -5
                echo ""
                echo "---"
                curl -s "https://tpix.online/health" 2>/dev/null
                echo ""
                echo "---"
                curl -s "https://tpix.online/favicon.svg" 2>/dev/null | head -3
                echo ""

                echo "=== Check Apache error log ==="
                tail -20 /var/log/httpd/domains/tpix.online.error.log 2>/dev/null || echo "No error log"
                echo ""

                echo "=== Check Apache access log ==="
                tail -10 /var/log/httpd/domains/tpix.online.log 2>/dev/null || echo "No access log"
                echo ""

                echo "=== Check PHP-FPM ==="
                ls -la /usr/local/php83/sockets/ 2>/dev/null
                ps aux | grep php-fpm | grep -v grep | head -5
                echo ""

                echo "=== DirectoryIndex setting ==="
                grep -ri "DirectoryIndex" /etc/httpd/conf/ 2>/dev/null | head -5
                grep -ri "DirectoryIndex" /usr/local/directadmin/ 2>/dev/null | head -5
                echo ""

                echo "=== Is there a reverse proxy (nginx)? ==="
                ps aux | grep -E "nginx|lshttpd|litespeed" | grep -v grep | head -5
                netstat -tlnp 2>/dev/null | grep -E ":80|:443" | head -5
                echo ""

                echo "=== Full tpix.online httpd config ==="
                grep -A 50 "tpix.online" /usr/local/directadmin/data/users/admin/httpd.conf 2>/dev/null | head -80
                echo ""

                echo "=== Cleanup ==="
                rm -f public_html/test.php
                echo "DIAGNOSE COMPLETE"
                ;;

              check-status)
                cd "$DEPLOY_PATH" 2>/dev/null || { echo "Path not found: $DEPLOY_PATH"; exit 1; }
                echo "=== Git Status ==="
                git log --oneline -3
                echo ""
                echo "=== PHP ==="
                php artisan --version
                echo ""
                echo "=== Build ==="
                ls -la public_html/build/ 2>/dev/null | head -5
                echo ""
                echo "=== .env ==="
                grep -E "^APP_ENV|^APP_DEBUG|^APP_URL|^DB_" .env 2>/dev/null | head -10
                echo ""
                echo "=== Disk ==="
                du -sh . 2>/dev/null
                ;;

              remove-workflow)
                echo "This workflow can be safely deleted from the repo after initial setup"
                ;;
            esac
