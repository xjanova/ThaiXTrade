name: Server Initial Setup

on:
  workflow_dispatch:
    inputs:
      task:
        description: 'Setup task to run'
        required: true
        type: choice
        options:
          - clone-and-setup
          - fix-build-and-env
          - check-status
          - remove-workflow

jobs:
  setup:
    name: Server Setup
    runs-on: ubuntu-latest

    steps:
      - name: Run setup via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          command_timeout: 10m
          script: |
            TASK="${{ inputs.task }}"
            DEPLOY_PATH="${{ secrets.DEPLOY_PATH }}"
            DEPLOY_PATH="${DEPLOY_PATH:-/home/admin/domains/tpix.online}"

            echo "Task: $TASK"
            echo "Path: $DEPLOY_PATH"
            echo "User: $(whoami)"

            case "$TASK" in
              clone-and-setup)
                echo "=== Step 1: Prepare directory ==="
                if [ -d "$DEPLOY_PATH/.git" ]; then
                  echo "Git repo already exists, pulling latest..."
                  cd "$DEPLOY_PATH"
                  git fetch origin main
                  git reset --hard origin/main
                else
                  echo "Cloning fresh repo..."
                  echo "Checking what exists..."
                  ls -la "$(dirname $DEPLOY_PATH)/" 2>/dev/null || echo "Parent dir not found"
                  ls -la "$DEPLOY_PATH/" 2>/dev/null || echo "Deploy path not found"

                  # Direct clone into deploy path
                  mkdir -p "$DEPLOY_PATH"
                  git clone https://github.com/xjanova/ThaiXTrade.git "$DEPLOY_PATH/repo_tmp"
                  # Move git content into deploy path
                  mv "$DEPLOY_PATH/repo_tmp/"* "$DEPLOY_PATH/repo_tmp/".[!.]* "$DEPLOY_PATH/" 2>/dev/null || true
                  rm -rf "$DEPLOY_PATH/repo_tmp"

                  cd "$DEPLOY_PATH"
                  echo "Cloned successfully. Files:"
                  ls -la | head -15
                fi

                echo "=== Step 2: Install Composer ==="
                composer install --no-dev --optimize-autoloader --no-interaction 2>&1 || {
                  echo "Trying with --no-scripts..."
                  composer install --no-dev --optimize-autoloader --no-interaction --no-scripts
                  composer dump-autoload --optimize
                }

                echo "=== Step 3: Setup .env ==="
                if [ ! -f ".env" ]; then
                  cp .env.example .env
                  php artisan key:generate --force
                  echo "Created new .env with fresh APP_KEY"
                else
                  echo ".env already exists, keeping it"
                fi

                echo "=== Step 4: NPM Install & Build ==="
                npm ci --prefer-offline 2>&1 || npm install 2>&1
                npm run build

                echo "=== Step 5: Database ==="
                php artisan migrate --force 2>&1 || echo "Migration warnings (non-fatal)"

                echo "=== Step 6: Permissions ==="
                chmod -R 775 storage bootstrap/cache 2>/dev/null || true
                chmod +x deploy.sh 2>/dev/null || true

                echo "=== Step 7: Optimize ==="
                php artisan config:clear
                php artisan route:clear
                php artisan view:clear
                php artisan config:cache
                php artisan route:cache
                php artisan view:cache

                echo "=== Step 8: Storage link ==="
                if [ ! -L "public_html/storage" ]; then
                  php artisan storage:link 2>/dev/null || true
                fi

                echo "=== Verify ==="
                php artisan --version
                ls -la public_html/build/ 2>/dev/null | head -5 || echo "No build dir yet"

                echo ""
                echo "=============================="
                echo "SETUP COMPLETE"
                echo "=============================="
                ;;

              fix-build-and-env)
                cd "$DEPLOY_PATH" || { echo "Path not found: $DEPLOY_PATH"; exit 1; }

                echo "=== Step 1: Configure .env for production ==="
                # Update .env for production
                sed -i 's/^APP_ENV=.*/APP_ENV=production/' .env
                sed -i 's/^APP_DEBUG=.*/APP_DEBUG=false/' .env
                sed -i 's|^APP_URL=.*|APP_URL=https://tpix.online|' .env

                echo "Current .env settings:"
                grep -E "^APP_ENV|^APP_DEBUG|^APP_URL|^DB_|^APP_KEY" .env

                echo ""
                echo "=== Step 2: Check Node.js ==="
                node --version
                npm --version
                echo "node_modules/.bin contents:"
                ls node_modules/.bin/vite 2>/dev/null && echo "vite binary found" || echo "vite binary NOT found"

                echo ""
                echo "=== Step 3: Reinstall NPM with devDependencies ==="
                npm install 2>&1
                echo "After install - vite check:"
                ls -la node_modules/.bin/vite 2>/dev/null || echo "Still no vite!"

                echo ""
                echo "=== Step 4: Build frontend assets ==="
                echo "Using direct node path to vite..."
                node ./node_modules/vite/bin/vite.js build 2>&1 || {
                  echo "Direct vite failed, trying with full path..."
                  NODE_PATH="$DEPLOY_PATH/node_modules" node "$DEPLOY_PATH/node_modules/vite/bin/vite.js" build 2>&1
                }

                echo ""
                echo "=== Step 5: Verify build output ==="
                ls -la public_html/build/ 2>/dev/null || echo "No build directory!"
                ls -la public_html/build/assets/ 2>/dev/null | head -10 || echo "No assets!"

                echo ""
                echo "=== Step 6: Re-cache Laravel ==="
                php artisan config:clear
                php artisan config:cache
                php artisan route:cache
                php artisan view:cache

                echo ""
                echo "=== Step 7: Fix permissions ==="
                chmod -R 775 storage bootstrap/cache 2>/dev/null || true
                chmod -R 775 public_html/build 2>/dev/null || true

                echo ""
                echo "=== Step 8: Test site ==="
                php artisan --version
                curl -s -o /dev/null -w "HTTP Status: %{http_code}" http://localhost 2>/dev/null || echo "Local curl not available"

                echo ""
                echo "=== Step 9: Check web server config ==="
                ls -la /home/admin/domains/tpix.online/ 2>/dev/null | head -10
                cat /home/admin/domains/tpix.online/nginx.conf 2>/dev/null | head -30 || echo "No nginx.conf in domain dir"
                ls /etc/nginx/sites-enabled/ 2>/dev/null || echo "No nginx sites-enabled"
                ls /etc/apache2/sites-enabled/ 2>/dev/null || echo "No apache sites-enabled"
                cat /usr/local/directadmin/data/users/admin/domains/tpix.online.conf 2>/dev/null | head -20 || echo "No DA domain config"

                echo ""
                echo "=== Step 10: Check DirectAdmin & public_html ==="
                echo "--- Domain root ---"
                ls -la "$DEPLOY_PATH/" 2>/dev/null | head -20
                echo "--- public_html contents ---"
                ls -la "$DEPLOY_PATH/public_html/" 2>/dev/null | head -20
                echo "--- index.php exists? ---"
                head -5 "$DEPLOY_PATH/public_html/index.php" 2>/dev/null || echo "NO index.php in public_html!"
                echo "--- .htaccess ---"
                cat "$DEPLOY_PATH/public_html/.htaccess" 2>/dev/null | head -25 || echo "No .htaccess"
                echo "--- Web server type ---"
                ls /usr/local/lsws/ 2>/dev/null && echo "OpenLiteSpeed detected" || echo "No OLS"
                nginx -v 2>&1 || echo "No nginx"
                apache2 -v 2>&1 || httpd -v 2>&1 || echo "No apache/httpd"
                echo "--- PHP handler ---"
                ls /usr/local/lsws/lsphp*/bin/lsphp 2>/dev/null || echo "No LSPHP"
                php -v 2>/dev/null | head -1

                echo ""
                echo "=============================="
                echo "BUILD & ENV FIX COMPLETE"
                echo "=============================="
                ;;

              check-status)
                cd "$DEPLOY_PATH" 2>/dev/null || { echo "Path not found: $DEPLOY_PATH"; exit 1; }
                echo "=== Git Status ==="
                git log --oneline -3
                echo ""
                echo "=== PHP ==="
                php artisan --version
                echo ""
                echo "=== Build ==="
                ls -la public_html/build/ 2>/dev/null | head -5
                echo ""
                echo "=== .env ==="
                grep -E "^APP_ENV|^APP_DEBUG|^APP_URL|^DB_" .env 2>/dev/null | head -10
                echo ""
                echo "=== Disk ==="
                du -sh . 2>/dev/null
                ;;

              remove-workflow)
                echo "This workflow can be safely deleted from the repo after initial setup"
                ;;
            esac
